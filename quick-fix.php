#!/usr/bin/env php
<?php
/**
 * å¿«é€Ÿä¿®å¤ï¼šä»Ž config.example.php åˆ›å»º config.php å¹¶æ·»åŠ  Cuisine
 */

echo "\nðŸ”§ å¿«é€Ÿä¿®å¤å·¥å…·\n";
echo str_repeat("=", 60) . "\n\n";

$configFile = __DIR__ . '/config.php';
$exampleFile = __DIR__ . '/config.example.php';

if (file_exists($configFile)) {
    echo "âš ï¸  config.php å·²å­˜åœ¨\n";
    echo "\næ˜¯å¦æŸ¥çœ‹å½“å‰é…ç½®? (y/n): ";
    $view = trim(fgets(STDIN));

    if (strtolower($view) === 'y') {
        echo "\nðŸ“„ å½“å‰ config.php:\n";
        echo str_repeat("-", 60) . "\n";
        echo file_get_contents($configFile);
        echo "\n" . str_repeat("-", 60) . "\n";
    }

    echo "\nè¯·é€‰æ‹©æ“ä½œ:\n";
    echo "  1) æ·»åŠ  Cuisine åˆ°çŽ°æœ‰é…ç½®\n";
    echo "  2) è¦†ç›–åˆ›å»ºæ–°é…ç½®\n";
    echo "  3) é€€å‡º\n";
    echo "é€‰æ‹© (1-3): ";
    $choice = trim(fgets(STDIN));

    if ($choice === '3') {
        echo "ðŸ‘‹ å·²é€€å‡º\n";
        exit(0);
    }

    if ($choice === '2') {
        $backup = $configFile . '.backup-' . date('YmdHis');
        copy($configFile, $backup);
        echo "âœ… å·²å¤‡ä»½åˆ°: $backup\n\n";
        unlink($configFile);
    }
}

if (!file_exists($configFile)) {
    // ä»Ž example åˆ›å»º
    if (!file_exists($exampleFile)) {
        die("âŒ é”™è¯¯: config.example.php ä¸å­˜åœ¨\n");
    }

    echo "ðŸ“‹ è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯:\n\n";

    echo "Home Assistant URL (ä¾‹å¦‚ http://192.168.1.100:8123): ";
    $haUrl = trim(fgets(STDIN));

    echo "Access Token: ";
    $token = trim(fgets(STDIN));

    echo "\nä¼ æ„Ÿå™¨ Entity IDs:\n";
    echo "YY æ¸©åº¦ (ä¾‹å¦‚ sensor.wen_shi_du_chuan_gan_qi_yy_temperature): ";
    $yyTemp = trim(fgets(STDIN));

    echo "YY æ¹¿åº¦ (ä¾‹å¦‚ sensor.wen_shi_du_chuan_gan_qi_yy_humidity): ";
    $yyHum = trim(fgets(STDIN));

    echo "\næ˜¯å¦æ·»åŠ  Cuisine (åŽ¨æˆ¿)? (y/n): ";
    $addCuisine = trim(fgets(STDIN));

    $cuisineTemp = '';
    $cuisineHum = '';

    if (strtolower($addCuisine) === 'y') {
        echo "Cuisine æ¸©åº¦: ";
        $cuisineTemp = trim(fgets(STDIN));

        echo "Cuisine æ¹¿åº¦: ";
        $cuisineHum = trim(fgets(STDIN));
    }

    // ç”Ÿæˆé…ç½®
    $config = <<<PHP
<?php
/**
 * Configuration pour Home Assistant Dashboard
 * Generated by quick-fix.php
 */

return [
    'home_assistant_url' => '$haUrl',
    'access_token' => '$token',
    'timeout' => 10,

    'sensor_groups' => [
        [
            'id' => 'yy_room',
            'name' => [
                'fr' => 'Chambre de YY',
                'en' => 'YY\\'s Room',
                'zh' => 'YYçš„æˆ¿é—´',
            ],
            'sensors' => [
                [
                    'type' => 'temperature',
                    'entity_id' => '$yyTemp',
                    'icon' => 'ðŸŒ¡ï¸',
                    'name' => [
                        'fr' => 'TempÃ©rature',
                        'en' => 'Temperature',
                        'zh' => 'æ¸©åº¦',
                    ],
                ],
                [
                    'type' => 'humidity',
                    'entity_id' => '$yyHum',
                    'icon' => 'ðŸ’§',
                    'name' => [
                        'fr' => 'HumiditÃ©',
                        'en' => 'Humidity',
                        'zh' => 'æ¹¿åº¦',
                    ],
                ],
            ],
        ],

PHP;

    if (strtolower($addCuisine) === 'y' && $cuisineTemp && $cuisineHum) {
        $config .= <<<PHP
        [
            'id' => 'cuisine',
            'name' => [
                'fr' => 'Cuisine',
                'en' => 'Kitchen',
                'zh' => 'åŽ¨æˆ¿',
            ],
            'sensors' => [
                [
                    'type' => 'temperature',
                    'entity_id' => '$cuisineTemp',
                    'icon' => 'ðŸŒ¡ï¸',
                    'name' => [
                        'fr' => 'TempÃ©rature',
                        'en' => 'Temperature',
                        'zh' => 'æ¸©åº¦',
                    ],
                ],
                [
                    'type' => 'humidity',
                    'entity_id' => '$cuisineHum',
                    'icon' => 'ðŸ’§',
                    'name' => [
                        'fr' => 'HumiditÃ©',
                        'en' => 'Humidity',
                        'zh' => 'æ¹¿åº¦',
                    ],
                ],
            ],
        ],

PHP;
    }

    $config .= <<<PHP
    ],

    'default_sensor_group' => 'yy_room',
];

PHP;

    if (file_put_contents($configFile, $config)) {
        echo "\nâœ… config.php åˆ›å»ºæˆåŠŸ!\n";
        echo "\nðŸ“‹ é…ç½®å†…å®¹:\n";
        echo str_repeat("-", 60) . "\n";
        echo $config;
        echo str_repeat("-", 60) . "\n";
        echo "\nðŸŽ¯ çŽ°åœ¨å¯ä»¥è®¿é—® sensors.php æµ‹è¯•äº†!\n\n";
    } else {
        die("âŒ æ— æ³•å†™å…¥ config.php\n");
    }

} else {
    // æ·»åŠ  Cuisine åˆ°çŽ°æœ‰é…ç½®
    $config = require $configFile;

    echo "\nè¾“å…¥ Cuisine ä¼ æ„Ÿå™¨ä¿¡æ¯:\n";
    echo "Cuisine æ¸©åº¦ entity_id: ";
    $cuisineTemp = trim(fgets(STDIN));

    echo "Cuisine æ¹¿åº¦ entity_id: ";
    $cuisineHum = trim(fgets(STDIN));

    if ($cuisineTemp && $cuisineHum) {
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰ Cuisine
        $hasCuisine = false;
        foreach ($config['sensor_groups'] as $group) {
            if ($group['id'] === 'cuisine') {
                $hasCuisine = true;
                break;
            }
        }

        if (!$hasCuisine) {
            $config['sensor_groups'][] = [
                'id' => 'cuisine',
                'name' => [
                    'fr' => 'Cuisine',
                    'en' => 'Kitchen',
                    'zh' => 'åŽ¨æˆ¿',
                ],
                'sensors' => [
                    [
                        'type' => 'temperature',
                        'entity_id' => $cuisineTemp,
                        'icon' => 'ðŸŒ¡ï¸',
                        'name' => [
                            'fr' => 'TempÃ©rature',
                            'en' => 'Temperature',
                            'zh' => 'æ¸©åº¦',
                        ],
                    ],
                    [
                        'type' => 'humidity',
                        'entity_id' => $cuisineHum,
                        'icon' => 'ðŸ’§',
                        'name' => [
                            'fr' => 'HumiditÃ©',
                            'en' => 'Humidity',
                            'zh' => 'æ¹¿åº¦',
                        ],
                    ],
                ],
            ];

            // å†™å›žæ–‡ä»¶
            $configCode = "<?php\nreturn " . var_export($config, true) . ";\n";
            if (file_put_contents($configFile, $configCode)) {
                echo "\nâœ… Cuisine é…ç½®å·²æ·»åŠ !\n\n";
            } else {
                die("âŒ æ— æ³•å†™å…¥é…ç½®æ–‡ä»¶\n");
            }
        } else {
            echo "\nâš ï¸  Cuisine é…ç½®å·²å­˜åœ¨\n";
        }
    }
}

echo "âœ¨ å®Œæˆ!\n\n";
